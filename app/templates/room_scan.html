{% extends "base.html" %}

{% block content %}
  <!-- Voice guidance for this page -->
  <div id="voiceGuidance" data-message="Time to photograph this room. Tap the Take Photos button and point your camera at your furniture and belongings. Try to get everything in the shot. Wide angle photos work best. Our clever computer will identify all your items automatically. When you're finished with this room, tap Done at the bottom." hidden></div>

  {% set room_icons = {
    "Living room": "ğŸ›‹ï¸",
    "Bed 1": "ğŸ›ï¸",
    "Bed 2": "ğŸ›ï¸",
    "Bed 3": "ğŸ›ï¸",
    "Bed 4": "ğŸ›ï¸",
    "Bed 5": "ğŸ›ï¸",
    "Kitchen": "ğŸ³",
    "Bathroom": "ğŸš¿",
    "Dining room": "ğŸ½ï¸",
    "Hallway": "ğŸšª",
    "Office": "ğŸ’¼",
    "Garage": "ğŸš—",
    "Loft": "ğŸ“¦",
    "Garden": "ğŸŒ³",
    "Other": "â•"
  } %}
  <div class="largetitle">{{ room_icons.get(room_name, "ğŸ“¦") }} {{ room_name }}</div>
  <p class="subtitle">Take photos and we'll detect your items</p>

  <div id="liveToast" class="toast hidden" role="status" aria-live="polite"></div>

  <div class="group">
    <input id="photoInput" type="file" accept="image/*" capture="environment" multiple class="hidden" />

    <button id="takeBtn" class="btn ready" type="button">ğŸ“¸ Take Photos</button>

    <div id="uploadWrap" class="uploadwrap hidden" aria-live="polite">
      <div class="uploadlabel" id="uploadLabel">Uploadingâ€¦</div>
      <div class="uploadbar"><div class="uploadfill" id="uploadFill" style="width:0%"></div></div>
    </div>

    <div class="hint" style="margin-top:10px;">
      Wide shots work best
    </div>
  </div>

  <div id="photosCard" class="group {% if not photos or photos|length==0 %}hidden{% endif %}">
    <div class="rowhead">
      <div class="rowtitle">Photos</div>
      <div class="rowsub"><span id="photoCount">{{ photos|length if photos else 0 }}</span></div>
    </div>
    <div id="photoGrid" class="photogrid">
      {% if photos %}
        {% for p in photos %}
          <div class="photo"><img class="photoimg" src="{{ p.url }}" alt="Photo" loading="lazy" /></div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  <div class="group" id="itemsCard">
    <div class="rowhead">
      <div class="rowtitle">âœ… Items detected</div>
      <div class="rowsub" id="itemsStatus">{{ items_json.get('items')|length if items_json and items_json.get('items') else 0 }} items</div>
    </div>

    <div id="itemsList" class="itemslist" style="margin-top:12px;">
      {% if items_json and items_json.get('items') and items_json.get('items')|length > 0 %}
        {% for item in items_json.get('items') %}
          <div class="itemrow">
            <div class="iteminfo">
              <div class="itemname">{{ item.qty }}x {{ item.name }}</div>
              {% if item.notes %}
                <div class="itemnotes">{{ item.notes }}</div>
              {% endif %}
            </div>
            {% if item.bulky %}
              <span class="badge">Bulky</span>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="empty" id="emptyState">
          <div class="empty-title">No items yet</div>
          <div class="empty-sub">Take photos to detect items</div>
        </div>
      {% endif %}
    </div>
  </div>

  <style>
    .item-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
    }
    .item-btn:active {
      transform: scale(0.95);
    }
    .item-increment-btn:hover {
      background: rgba(46, 229, 157, 0.15);
      border-color: rgba(46, 229, 157, 0.3);
      color: #2ee59d;
    }
    .item-delete-btn:hover {
      background: rgba(255, 80, 80, 0.15);
      border-color: rgba(255, 80, 80, 0.3);
      color: #ff5050;
    }
    .variant-select {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      margin-top: 4px;
      cursor: pointer;
      max-width: 180px;
    }
    .variant-select:focus {
      border-color: rgba(46,229,157,.4);
      outline: none;
    }

    /* Photo processing state */
    .photo-processing {
      position: relative;
    }
    .photo-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
    }
    .photo-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: #2ee59d;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Better upload progress styling */
    #uploadWrap {
      background: rgba(46, 229, 157, 0.08);
      border: 1px solid rgba(46, 229, 157, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }
    #uploadLabel {
      font-size: 14px;
      font-weight: 600;
      color: #2ee59d;
      margin-bottom: 8px;
    }
  </style>

  <script>
    let currentItems = {{ items_json.get('items', []) | tojson | safe }};
    const variantMap = {{ variant_map_js | tojson | safe }};

    // DOM references
    const _toast = document.getElementById("liveToast");
    const _itemsStatus = document.getElementById("itemsStatus");
    const _itemsList = document.getElementById("itemsList");

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function showToast(msg){
      _toast.textContent = msg;
      _toast.classList.remove("hidden");
      setTimeout(() => _toast.classList.add("hidden"), 1500);
    }

    // Client-side variant lookup for items added via AJAX
    function getVariantsForName(name) {
      const lower = (name || "").toLowerCase();
      let best = null;
      let bestLen = 0;
      for (const [cat, data] of Object.entries(variantMap)) {
        for (const kw of data.keywords) {
          if (lower.includes(kw) && kw.length > bestLen) {
            best = data.variants;
            bestLen = kw.length;
          }
        }
      }
      return best;
    }

    function renderItems(items){
      if(!items || items.length === 0){
        _itemsList.innerHTML = '<div class="empty"><div class="empty-title">No items yet</div><div class="empty-sub">Take photos to detect items</div></div>';
        _itemsStatus.textContent = "0 items";
        return;
      }

      _itemsStatus.textContent = items.length + " items";

      _itemsList.innerHTML = items.map((it, idx) => {
        const name = escapeHtml(it.name || "");
        const qty = Number(it.qty || 1);
        const notes = escapeHtml(it.notes || "");
        const bulky = it.bulky;

        // Variant dropdown: use server-provided variants or client-side lookup
        const variants = it.variants || getVariantsForName(it.name) || [];
        let variantHtml = '';
        if (variants.length > 1) {
          const opts = variants.map(v => {
            const vn = escapeHtml(v);
            const sel = (v.toLowerCase() === (it.name || "").toLowerCase()) ? 'selected' : '';
            return `<option value="${vn}" ${sel}>${vn}</option>`;
          }).join('');
          variantHtml = `<select class="variant-select" onchange="changeVariant(${idx}, this)">${opts}</select>`;
        }

        return `
          <div class="itemrow" id="item-${idx}">
            <div class="iteminfo">
              <div class="itemname">${qty}x ${name}</div>
              ${variantHtml}
              ${notes ? `<div class="itemnotes">${notes}</div>` : ''}
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              ${bulky ? '<span class="badge">Bulky</span>' : ''}
              <button class="item-btn item-increment-btn" onclick="incrementItem(${idx}, '${escapeHtml(name)}')" title="Add another">+1</button>
              <button class="item-btn item-delete-btn" onclick="deleteItem(${idx}, '${escapeHtml(name)}')" title="Remove this item">âœ•</button>
            </div>
          </div>
        `;
      }).join("");
    }

    async function changeVariant(index, selectEl) {
      const variantName = selectEl.value;
      try {
        const fd = new FormData();
        fd.append('variant_name', variantName);
        const resp = await fetch("/s/{{ company_slug }}/{{ token }}/room/{{ room_id }}/update-variant/" + index, {
          method: "POST", body: fd
        });
        if (resp.ok) {
          const data = await resp.json();
          currentItems[index].name = data.new_name;
          currentItems[index].weight_kg = data.weight_kg;
          currentItems[index].cbm = data.cbm;
          currentItems[index].bulky = data.bulky;
          currentItems[index].length_cm = data.length_cm;
          currentItems[index].width_cm = data.width_cm;
          currentItems[index].height_cm = data.height_cm;
          currentItems[index].variants = data.variants;
          renderItems(currentItems);
          showToast("Updated to " + data.new_name);
        } else {
          showToast("Failed to update");
        }
      } catch (err) {
        console.error(err);
        showToast("Error updating");
      }
    }

    async function incrementItem(index, itemName) {
      try {
        const response = await fetch("/s/{{ company_slug }}/{{ token }}/room/{{ room_id }}/increment-item/" + index, {
          method: "POST"
        });

        if (response.ok) {
          const data = await response.json();
          currentItems[index].qty = data.new_qty;
          renderItems(currentItems);
          showToast(`${itemName} x${data.new_qty}`);
        } else {
          showToast("Failed to update item");
        }
      } catch (err) {
        console.error(err);
        showToast("Error updating item");
      }
    }

    async function deleteItem(index, itemName) {
      if (!confirm(`Remove "${itemName}" from this room?`)) return;

      try {
        const response = await fetch("/s/{{ company_slug }}/{{ token }}/room/{{ room_id }}/delete-item/" + index, {
          method: "DELETE"
        });

        if (response.ok) {
          currentItems.splice(index, 1);
          renderItems(currentItems);
          showToast("Item removed");
        } else {
          showToast("Failed to remove item");
        }
      } catch (err) {
        console.error(err);
        showToast("Error removing item");
      }
    }

    // Photo upload handler with instant preview
    (function () {
      const uploadUrl = "/s/{{ company_slug }}/{{ token }}/room/{{ room_id }}/upload-json";

      const input = document.getElementById("photoInput");
      const takeBtn = document.getElementById("takeBtn");

      const wrap = document.getElementById("uploadWrap");
      const fill = document.getElementById("uploadFill");
      const label = document.getElementById("uploadLabel");

      const photosCard = document.getElementById("photosCard");
      const photoGrid = document.getElementById("photoGrid");
      const photoCount = document.getElementById("photoCount");

      // Track existing photos for proper counting
      let existingPhotoCount = {{ photos|length if photos else 0 }};
      let pendingPreviews = [];

      function setUploading(on, phase){
        if(on){
          wrap.classList.remove("hidden");
          takeBtn.disabled = true;
          takeBtn.classList.remove("ready");
          if(phase === 'uploading'){
            takeBtn.textContent = "ğŸ“¤ Uploading...";
            label.textContent = "Uploading photos...";
          } else {
            takeBtn.textContent = "ğŸ¤– AI Analyzing...";
            label.textContent = "âœ¨ AI detecting items...";
          }
        } else {
          wrap.classList.add("hidden");
          takeBtn.disabled = false;
          takeBtn.classList.add("ready");
          takeBtn.textContent = "ğŸ“¸ Take Photos";
        }
      }

      function setProgress(pct, phase){
        const clamped = Math.max(0, Math.min(100, pct));
        fill.style.width = clamped + "%";
        if(phase === 'uploading'){
          label.textContent = clamped >= 100 ? "Upload complete!" : ("Uploadingâ€¦ " + clamped + "%");
        } else {
          label.textContent = "âœ¨ AI detecting items...";
        }
      }

      // Show instant local preview before upload
      function showLocalPreviews(files){
        photosCard.classList.remove("hidden");
        pendingPreviews = [];

        for(const file of files){
          const reader = new FileReader();
          reader.onload = function(e){
            const previewHtml = `
              <div class="photo photo-processing" data-preview="true">
                <img class="photoimg" src="${e.target.result}" alt="Processing..." />
                <div class="photo-overlay">
                  <div class="photo-spinner"></div>
                </div>
              </div>
            `;
            photoGrid.insertAdjacentHTML('beforeend', previewHtml);
            pendingPreviews.push(e.target.result);
            photoCount.textContent = String(existingPhotoCount + pendingPreviews.length);
          };
          reader.readAsDataURL(file);
        }
      }

      // Replace previews with actual server photos
      function finalizePhotos(serverPhotos){
        // Remove all preview photos
        const previews = photoGrid.querySelectorAll('[data-preview="true"]');
        previews.forEach(p => p.remove());
        pendingPreviews = [];

        // Add server photos
        if(serverPhotos && serverPhotos.length > 0){
          existingPhotoCount = serverPhotos.length;
          photoCount.textContent = String(serverPhotos.length);

          // Re-render all photos from server
          photoGrid.innerHTML = serverPhotos.map(p =>
            `<div class="photo"><img class="photoimg" src="${escapeHtml(p.url)}" alt="Photo" loading="lazy"/></div>`
          ).join("");
        }
      }

      takeBtn.addEventListener("click", () => input.click());

      input.addEventListener("change", async () => {
        if (!input.files || input.files.length === 0) return;

        // Show instant previews
        showLocalPreviews(input.files);

        setUploading(true, 'uploading');
        _itemsStatus.textContent = "Detecting items...";

        const data = new FormData();
        for (const f of input.files) data.append("photos", f);

        try {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", uploadUrl, true);

          xhr.upload.onprogress = function (evt) {
            if (!evt.lengthComputable) return;
            const pct = Math.round((evt.loaded / evt.total) * 100);
            setProgress(pct, 'uploading');
            if(pct >= 100){
              // Upload done, now AI is analyzing
              setUploading(true, 'analyzing');
              fill.style.width = "100%";
            }
          };

          xhr.onload = function () {
            setUploading(false);

            if (xhr.status < 200 || xhr.status >= 300) {
              showToast("Upload failed - please try again");
              // Remove failed previews
              const previews = photoGrid.querySelectorAll('[data-preview="true"]');
              previews.forEach(p => p.remove());
              pendingPreviews = [];
              photoCount.textContent = String(existingPhotoCount);
              return;
            }

            const payload = JSON.parse(xhr.responseText || "{}");
            if (!payload.ok) {
              showToast("Upload failed - please try again");
              const previews = photoGrid.querySelectorAll('[data-preview="true"]');
              previews.forEach(p => p.remove());
              pendingPreviews = [];
              photoCount.textContent = String(existingPhotoCount);
              return;
            }

            // Replace previews with server photos
            finalizePhotos(payload.photos || []);

            const newItems = (payload.items_json && payload.items_json.items) ? payload.items_json.items : [];
            // Add client-side variants for newly detected items
            newItems.forEach(it => {
              if (!it.variants) it.variants = getVariantsForName(it.name);
            });
            currentItems = newItems;
            renderItems(currentItems);

            if(newItems.length > 0){
              showToast(`âœ… Found ${newItems.length} items!`);
            } else {
              showToast("ğŸ“· Photo saved - no items detected");
            }
          };

          xhr.onerror = function () {
            setUploading(false);
            showToast("Connection error - please try again");
            const previews = photoGrid.querySelectorAll('[data-preview="true"]');
            previews.forEach(p => p.remove());
            pendingPreviews = [];
            photoCount.textContent = String(existingPhotoCount);
          };

          xhr.send(data);
        } catch (e) {
          setUploading(false);
          showToast("Error - please try again");
          const previews = photoGrid.querySelectorAll('[data-preview="true"]');
          previews.forEach(p => p.remove());
          pendingPreviews = [];
          photoCount.textContent = String(existingPhotoCount);
        } finally {
          input.value = "";
        }
      });
    })();

    // Render items on page load (enables +1/delete/variant buttons for server-rendered items)
    renderItems(currentItems);
  </script>
{% endblock %}

{% block footer %}
  <div class="footer footer-clean">
    <div class="footer-inner">
      <a class="btn" href="/s/{{ company_slug }}/{{ token }}/rooms">âœ“ Done with this room</a>
    </div>
  </div>
{% endblock %}
