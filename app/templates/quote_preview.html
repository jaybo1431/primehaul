{% extends "base.html" %}

{% block content %}
  {% if job.status == 'approved' %}
    <div class="largetitle">Quote approved</div>
    <p class="subtitle">Your quote is ready to book. Secure your moving date now.</p>
  {% elif job.status == 'awaiting_approval' %}
    <div class="largetitle">Quote submitted</div>
    <p class="subtitle">Our team is reviewing your quote. We'll notify you when it's approved.</p>
  {% else %}
    <div class="largetitle">Your quote</div>
    <p class="subtitle">AI-powered estimate. Submit for review when ready.</p>
  {% endif %}

  <div class="group">
    {% if job.status == 'approved' and job.final_quote_price %}
      <!-- Show final fixed price for approved quotes -->
      <div class="bigprice" style="color:#2ee59d;">¬£{{ job.final_quote_price }}</div>
      <div class="pill" style="background:rgba(46,229,157,.15); color:#2ee59d; border-color:rgba(46,229,157,.3);">‚úì Final Quote</div>
    {% elif job.status == 'approved' %}
      <!-- Fallback for approved without final price (legacy) -->
      <div class="bigprice">¬£{{ estimate_low }} ‚Äì ¬£{{ estimate_high }}</div>
      <div class="pill" style="background:rgba(46,229,157,.15); color:#2ee59d; border-color:rgba(46,229,157,.3);">‚úì Approved</div>
    {% elif job.status == 'awaiting_approval' %}
      <div class="bigprice">¬£{{ estimate_low }} ‚Äì ¬£{{ estimate_high }}</div>
      <div class="pill" style="background:rgba(96,165,250,.15); color:#60a5fa; border-color:rgba(96,165,250,.3);">‚è≥ Pending Review</div>
    {% else %}
      <div class="bigprice">¬£{{ estimate_low }} ‚Äì ¬£{{ estimate_high }}</div>
      <div class="pill">{{ confidence }}</div>
    {% endif %}

    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Move summary</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Items detected</span>
            <span class="statrow-value">{{ total_items }}</span>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Collection</span>
            <span class="statrow-value">{{ job.property_type|title|replace('_', ' ') if job.property_type else 'Not specified' }}</span>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Delivery</span>
            <span class="statrow-value">{{ job.dropoff_property_type|title|replace('_', ' ') if job.dropoff_property_type else 'Not specified' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Route details{% if distance_miles > 0 %} <span style="font-weight:400; color:var(--muted);">({{ "%.0f"|format(distance_miles) }} miles)</span>{% endif %}</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Pickup</div>
            <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.pickup.label if job.pickup else "Not set" }}</div>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Delivery</div>
            <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.dropoff.label if job.dropoff else "Not set" }}</div>
          </div>
        </div>
        {% if job.move_date %}
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Move date</div>
            <div style="font-size:14px; font-weight:600;">{{ job.move_date.strftime('%A, %d %B %Y') }}</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    {% if packing_breakdown and (packing_breakdown.small_boxes.qty > 0 or packing_breakdown.medium_boxes.qty > 0 or packing_breakdown.large_boxes.qty > 0 or packing_breakdown.robe_cartons.qty > 0) %}
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Packing materials needed</div>

      <div style="padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); margin-bottom:12px;">
        <div style="display:flex; flex-direction:column; gap:8px; font-size:14px;">
          {% if packing_breakdown.small_boxes.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Small boxes (18√ó18√ó10")</div>
            <div style="font-weight:600;">{{ packing_breakdown.small_boxes.qty }} boxes</div>
          </div>
          {% endif %}
          {% if packing_breakdown.medium_boxes.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Medium boxes (18√ó18√ó20")</div>
            <div style="font-weight:600;">{{ packing_breakdown.medium_boxes.qty }} boxes</div>
          </div>
          {% endif %}
          {% if packing_breakdown.large_boxes.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Large boxes (18√ó18√ó30")</div>
            <div style="font-weight:600;">{{ packing_breakdown.large_boxes.qty }} boxes</div>
          </div>
          {% endif %}
          {% if packing_breakdown.robe_cartons.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Wardrobe cartons</div>
            <div style="font-weight:600;">{{ packing_breakdown.robe_cartons.qty }} cartons</div>
          </div>
          {% endif %}
          {% if packing_breakdown.mattress_covers.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Mattress covers</div>
            <div style="font-weight:600;">{{ packing_breakdown.mattress_covers.qty }} covers</div>
          </div>
          {% endif %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Tape & packing paper</div>
            <div style="font-weight:600;">{{ packing_breakdown.tape_rolls.qty }} rolls, {{ "%.1f"|format(packing_breakdown.paper_packs.qty) }} packs</div>
          </div>
        </div>
      </div>

      <form method="post" action="/s/{{ company_slug }}/{{ token }}/packing-preference" style="margin-bottom:12px;">
        <label style="display:flex; align-items:center; padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); cursor:pointer;">
          <input type="radio" name="use_company_packing" value="yes" {% if not job.customer_provides_packing %}checked{% endif %} style="margin-right:12px;" onchange="this.form.submit()">
          <div style="flex:1;">
            <div style="font-weight:600; margin-bottom:3px;">Use our packing materials</div>
            <div style="font-size:13px; color:var(--muted);">We'll provide all boxes, tape, and paper (+¬£{{ "%.2f"|format(breakdown.packing) }})</div>
          </div>
        </label>

        <label style="display:flex; align-items:center; padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); cursor:pointer; margin-top:8px;">
          <input type="radio" name="use_company_packing" value="no" {% if job.customer_provides_packing %}checked{% endif %} style="margin-right:12px;" onchange="this.form.submit()">
          <div style="flex:1;">
            <div style="font-weight:600; margin-bottom:3px;">I'll provide my own</div>
            <div style="font-size:13px; color:var(--muted);">No charge - bring the materials listed above</div>
          </div>
        </label>
      </form>

      {% if job.customer_provides_packing %}
      <div style="padding:12px; border-radius:8px; background:rgba(46,229,157,.1); border:1px solid rgba(46,229,157,.3); font-size:13px;">
        You'll provide your own packing materials. Make sure you have everything listed above ready for moving day.
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if packing_service_breakdown and packing_service_breakdown.rooms %}
    <div style="margin-top:20px; padding-top:16px; border-top:1px solid var(--hair);">
      <!-- Glowing Packing CTA Card -->
      <div style="border-radius:14px; background:linear-gradient(135deg, rgba(46,229,157,.08), rgba(46,229,157,.03)); border:1px solid rgba(46,229,157,.3); animation:glowPulse 3s ease-in-out infinite; overflow:hidden;">
        <!-- Header -->
        <div style="padding:16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(46,229,157,.15);">
          <div style="width:44px; height:44px; border-radius:10px; background:rgba(46,229,157,.15); display:flex; align-items:center; justify-content:center; font-size:22px;">üì¶</div>
          <div style="flex:1;">
            <div style="font-weight:700; font-size:16px; color:#2ee59d;">Need Help Packing?</div>
            <div style="font-size:13px; color:var(--muted);">We'll pack everything for you</div>
          </div>
          {% if packing_service_breakdown.total_cost > 0 %}
          <div style="text-align:right;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px;">From</div>
            <div style="font-weight:800; font-size:18px; color:#2ee59d;">+¬£{{ "%.0f"|format(packing_service_breakdown.total_cost) }}</div>
          </div>
          {% endif %}
        </div>

        <!-- Room Selection -->
        <div style="padding:12px 16px 16px;">
          <form id="packingServiceForm" method="post" action="/s/{{ company_slug }}/{{ token }}/packing-service" style="display:flex; flex-direction:column; gap:8px;">
            {% for room in packing_service_breakdown.rooms %}
            <label style="display:flex; align-items:center; padding:12px 14px; border-radius:10px; background:{% if room.is_selected %}rgba(46,229,157,.12){% else %}rgba(255,255,255,.04){% endif %}; border:1px solid {% if room.is_selected %}rgba(46,229,157,.4){% else %}rgba(255,255,255,.08){% endif %}; cursor:pointer; transition:all 150ms ease;">
              <input type="checkbox" name="room_ids" value="{{ room.room_id }}" {% if room.is_selected %}checked{% endif %} style="width:20px; height:20px; margin-right:12px; accent-color:#2ee59d;" onchange="document.getElementById('packingServiceForm').submit()">
              <div style="flex:1;">
                <div style="font-weight:600;">{{ room.room_name }}</div>
                <div style="font-size:12px; color:var(--muted);">{{ room.items_count }} items</div>
              </div>
              <div style="font-weight:700; color:#2ee59d; font-size:15px;">+¬£{{ "%.0f"|format(room.cost) }}</div>
            </label>
            {% endfor %}
          </form>
          <div style="margin-top:12px; padding:10px 12px; border-radius:8px; background:rgba(46,229,157,.08); font-size:12px; color:rgba(46,229,157,.9); text-align:center;">
            Professional packing service ‚Äî all materials included
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if company.tcs_document_url %}
    <div style="margin-top:16px; padding:12px 16px; border-radius:10px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between;">
      <span style="font-size:13px; color:var(--muted);">Terms & Conditions</span>
      <a href="/s/{{ company_slug }}/{{ token }}/tcs/view" target="_blank" style="padding:8px 14px; background:rgba(255,255,255,.08); border-radius:6px; text-decoration:none; color:var(--text); font-weight:600; font-size:13px;">
        View ‚Üí
      </a>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block footer %}
  <div class="footer footer-clean">
    <div class="footer-inner">
      {% if job.status == 'approved' %}
        <a href="/s/{{ company_slug }}/{{ token }}/quote/accept" class="btn" style="text-decoration:none; display:block;">
          Accept This Quote
        </a>
        <div class="microhint" style="text-align:center; margin-top:8px;">
          Quote approved ‚Ä¢ Accept to continue with booking
        </div>
      {% elif job.status == 'in_progress' %}
        <form method="post" action="/s/{{ company_slug }}/{{ token }}/submit-quote">
          <button class="btn" type="submit">Submit for review</button>
          <div class="microhint" style="text-align:center; margin-top:8px;">
            Usually confirmed within 2 hours
          </div>
        </form>
      {% elif job.status == 'awaiting_approval' %}
        <div style="text-align:center;">
          <div class="btn" style="opacity:.7; pointer-events:none; background:rgba(96,165,250,.3); color:#60a5fa; border:1px solid rgba(96,165,250,.5);">
            ‚è≥ Awaiting approval
          </div>
          <div class="microhint" style="margin-top:8px;">
            We're reviewing your quote. You'll receive a text when it's ready!
          </div>
        </div>
      {% endif %}
      <a href="/s/{{ company_slug }}/{{ token }}/photos/bulk" class="btn secondary" style="margin-top:10px;">
        ‚Üê Upload More Photos
      </a>
    </div>
  </div>
{% endblock %}
