{% extends "base.html" %}

{% block content %}
  {% if auto_approved %}
    <div class="largetitle">Quote approved</div>
    <p class="subtitle">Your quote is ready to book. Secure your moving date now.</p>
  {% else %}
    <div class="largetitle">Your quote</div>
    <p class="subtitle">AI-powered estimate. Our team will review and confirm within 2 hours.</p>
  {% endif %}

  <div class="group">
    <div class="bigprice">¬£{{ estimate_low }} ‚Äì ¬£{{ estimate_high }}</div>
    {% if auto_approved %}
      <div class="pill" style="background:rgba(255,255,255,.1); color:#ffffff; border-color:rgba(255,255,255,.3);">Approved</div>
    {% else %}
      <div class="pill">{{ confidence }}</div>
    {% endif %}

    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Move summary</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Items detected</span>
            <span class="statrow-value">{{ total_items }}</span>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Property type</span>
            <span class="statrow-value">{{ job.property_type|title|replace('_', ' ') if job.property_type else 'Not specified' }}</span>
          </div>
        </div>
      </div>
      <div style="margin-top:12px; padding:12px; border-radius:8px; background:rgba(255,255,255,.05); font-size:13px; color:var(--muted); border:1px solid rgba(255,255,255,.1);">
        Our team will review your inventory and confirm within 2 hours
      </div>
    </div>

    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Route details</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Pickup</div>
            <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.pickup.label if job.pickup else "Not set" }}</div>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Delivery</div>
            <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.dropoff.label if job.dropoff else "Not set" }}</div>
          </div>
        </div>
        {% if job.move_date %}
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Move date</div>
            <div style="font-size:14px; font-weight:600;">{{ job.move_date.strftime('%A, %d %B %Y') }}</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    {% if packing_breakdown and (packing_breakdown.small_boxes.qty > 0 or packing_breakdown.medium_boxes.qty > 0 or packing_breakdown.large_boxes.qty > 0 or packing_breakdown.robe_cartons.qty > 0) %}
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Packing materials needed</div>

      <div style="padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); margin-bottom:12px;">
        <div style="display:flex; flex-direction:column; gap:8px; font-size:14px;">
          {% if packing_breakdown.small_boxes.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Small boxes (18√ó18√ó10")</div>
            <div style="font-weight:600;">{{ packing_breakdown.small_boxes.qty }} boxes</div>
          </div>
          {% endif %}
          {% if packing_breakdown.medium_boxes.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Medium boxes (18√ó18√ó20")</div>
            <div style="font-weight:600;">{{ packing_breakdown.medium_boxes.qty }} boxes</div>
          </div>
          {% endif %}
          {% if packing_breakdown.large_boxes.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Large boxes (18√ó18√ó30")</div>
            <div style="font-weight:600;">{{ packing_breakdown.large_boxes.qty }} boxes</div>
          </div>
          {% endif %}
          {% if packing_breakdown.robe_cartons.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Wardrobe cartons</div>
            <div style="font-weight:600;">{{ packing_breakdown.robe_cartons.qty }} cartons</div>
          </div>
          {% endif %}
          {% if packing_breakdown.mattress_covers.qty > 0 %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Mattress covers</div>
            <div style="font-weight:600;">{{ packing_breakdown.mattress_covers.qty }} covers</div>
          </div>
          {% endif %}
          <div class="statrow">
            <div style="flex:1; color:var(--muted);">Tape & packing paper</div>
            <div style="font-weight:600;">{{ packing_breakdown.tape_rolls.qty }} rolls, {{ "%.1f"|format(packing_breakdown.paper_packs.qty) }} packs</div>
          </div>
        </div>
      </div>

      <form method="post" action="/s/{{ company_slug }}/{{ token }}/packing-preference" style="margin-bottom:12px;">
        <label style="display:flex; align-items:center; padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); cursor:pointer;">
          <input type="radio" name="use_company_packing" value="yes" {% if not job.customer_provides_packing %}checked{% endif %} style="margin-right:12px;" onchange="this.form.submit()">
          <div style="flex:1;">
            <div style="font-weight:600; margin-bottom:3px;">Use our packing materials</div>
            <div style="font-size:13px; color:var(--muted);">We'll provide all boxes, tape, and paper (+¬£{{ "%.2f"|format(breakdown.packing) }})</div>
          </div>
        </label>

        <label style="display:flex; align-items:center; padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); cursor:pointer; margin-top:8px;">
          <input type="radio" name="use_company_packing" value="no" {% if job.customer_provides_packing %}checked{% endif %} style="margin-right:12px;" onchange="this.form.submit()">
          <div style="flex:1;">
            <div style="font-weight:600; margin-bottom:3px;">I'll provide my own</div>
            <div style="font-size:13px; color:var(--muted);">No charge - bring the materials listed above</div>
          </div>
        </label>
      </form>

      {% if job.customer_provides_packing %}
      <div style="padding:12px; border-radius:8px; background:rgba(46,229,157,.1); border:1px solid rgba(46,229,157,.3); font-size:13px;">
        You'll provide your own packing materials. Make sure you have everything listed above ready for moving day.
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if packing_service_breakdown and packing_service_breakdown.rooms %}
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <details style="cursor:pointer;">
        <summary style="font-weight:700; margin-bottom:12px; list-style:none; display:flex; align-items:center; justify-content:space-between;">
          <span>Need help packing? (Optional)</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </summary>

        <div style="margin-top:12px;">
          <div style="padding:12px; border-radius:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); font-size:13px; color:var(--muted); margin-bottom:12px;">
            Select which rooms you'd like our team to pack for you. Materials and labor included in the price.
          </div>

          <form id="packingServiceForm" method="post" action="/s/{{ company_slug }}/{{ token }}/packing-service" style="display:flex; flex-direction:column; gap:8px;">
            {% for room in packing_service_breakdown.rooms %}
            <label style="display:flex; align-items:center; padding:14px; border-radius:12px; background:{% if room.is_selected %}rgba(255,255,255,.1){% else %}rgba(255,255,255,.05){% endif %}; border:1px solid {% if room.is_selected %}rgba(255,255,255,.3){% else %}rgba(255,255,255,.1){% endif %}; cursor:pointer; transition:all 0.2s;">
              <input type="checkbox" name="room_ids" value="{{ room.room_id }}" {% if room.is_selected %}checked{% endif %} style="margin-right:12px;" onchange="document.getElementById('packingServiceForm').submit()">
              <div style="flex:1;">
                <div style="font-weight:600; margin-bottom:3px;">{{ room.room_name }}</div>
                <div style="font-size:12px; color:var(--muted);">{{ room.items_count }} items ‚Ä¢ ~{{ room.hours }}h packing</div>
              </div>
              <div style="font-weight:700; font-size:16px;">+¬£{{ "%.0f"|format(room.cost) }}</div>
            </label>
            {% endfor %}

            {% if packing_service_breakdown.total_cost > 0 %}
            <div style="margin-top:8px; padding:14px; border-radius:12px; background:rgba(46,229,157,.1); border:1px solid rgba(46,229,157,.3);">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:700; margin-bottom:3px;">Packing service total</div>
                  <div style="font-size:13px; color:var(--muted);">{{ packing_service_breakdown.total_hours }}h labor + materials included</div>
                </div>
                <div style="font-weight:700; font-size:20px; color:#2ee59d;">+¬£{{ "%.0f"|format(packing_service_breakdown.total_cost) }}</div>
              </div>
            </div>
            {% endif %}
          </form>

          <div style="margin-top:12px; padding:12px; border-radius:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); font-size:12px; color:var(--muted);">
            <strong>Or pack everything yourself</strong> - Just uncheck all rooms above. You can choose to bring your own materials or use ours.
          </div>
        </div>
      </details>
    </div>
    {% endif %}

    {% if company.tcs_document_url %}
    <!-- Terms & Conditions Preview -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">üìã Terms & Conditions</div>
      <div style="padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap: wrap;">
          <div style="flex:1; min-width: 200px;">
            <div style="font-weight:600; margin-bottom:4px;">Review Our Terms</div>
            <div style="font-size:13px; color:var(--muted);">
              {% if company.tcs_enabled %}
              You'll need to accept these before booking
              {% else %}
              Available for your reference
              {% endif %}
            </div>
          </div>
          <a href="/s/{{ company_slug }}/{{ token }}/tcs/view" target="_blank" style="padding:10px 16px; background:rgba(255,255,255,.1); border-radius:8px; text-decoration:none; color:var(--text); font-weight:600; font-size:14px; white-space:nowrap;">
            View PDF ‚Üí
          </a>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block footer %}
  <div class="footer footer-clean">
    <div class="footer-inner">
      {% if auto_approved or job.status == 'approved' %}
        <a href="/s/{{ company_slug }}/{{ token }}/quote/accept" class="btn" style="text-decoration:none; display:block;">
          Accept This Quote
        </a>
        <div class="microhint" style="text-align:center; margin-top:8px;">
          Quote approved ‚Ä¢ Accept to continue with booking
        </div>
      {% elif job.status == 'in_progress' %}
        <form method="post" action="/s/{{ company_slug }}/{{ token }}/submit-quote">
          <button class="btn" type="submit">Submit for review</button>
          <div class="microhint" style="text-align:center; margin-top:8px;">
            Our team will confirm your quote within 2 hours
          </div>
        </form>
      {% elif job.status == 'awaiting_approval' %}
        <div style="text-align:center;">
          <div class="btn" style="opacity:.7; pointer-events:none; background:rgba(255,165,0,.3); color:#ffa500; border:1px solid rgba(255,165,0,.5);">
            Awaiting approval
          </div>
          <div class="microhint" style="margin-top:8px;">
            We're reviewing your quote. You'll receive a text when it's ready!
          </div>
        </div>
      {% endif %}
      <a href="/s/{{ company_slug }}/{{ token }}/photos/bulk" class="btn secondary" style="margin-top:10px;">
        ‚Üê Upload More Photos
      </a>
    </div>
  </div>
{% endblock %}
