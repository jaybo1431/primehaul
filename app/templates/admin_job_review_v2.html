<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/app.css"/>
  <style>
    .price-edit-form{
      display:none;
      padding:16px;
      border-radius:12px;
      background:rgba(255,165,0,.1);
      border:1px solid rgba(255,165,0,.3);
      margin-top:12px;
    }
    .price-edit-form.active{
      display:block;
    }
    .notes-section{
      max-height:300px;
      overflow-y:auto;
    }
    .note-item{
      padding:10px;
      border-left:3px solid rgba(255,165,0,.5);
      background:rgba(255,255,255,.02);
      margin-bottom:8px;
      border-radius:0 8px 8px 0;
    }
    .note-time{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .note-text{
      font-size:14px;
      line-height:1.4;
    }
    .lightbox{
      display:none;
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(0,0,0,.95);
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .lightbox.active{
      display:flex;
    }
    .lightbox-img{
      max-width:100%;
      max-height:90vh;
      object-fit:contain;
      border-radius:12px;
    }
    .lightbox-close{
      position:absolute;
      top:20px;
      right:20px;
      background:rgba(255,255,255,.9);
      color:#000;
      border:none;
      width:40px;
      height:40px;
      border-radius:50%;
      font-size:24px;
      cursor:pointer;
      font-weight:700;
    }
    .lightbox-nav{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:rgba(255,255,255,.9);
      color:#000;
      border:none;
      width:50px;
      height:50px;
      border-radius:50%;
      font-size:24px;
      cursor:pointer;
      font-weight:700;
    }
    .lightbox-prev{
      left:20px;
    }
    .lightbox-next{
      right:20px;
    }
    .photo-thumb{
      cursor:pointer;
      transition:all 200ms;
    }
    .photo-thumb:hover{
      transform:scale(1.05);
      box-shadow:0 0 20px rgba(255,255,255,.3);
    }
    .custom-price-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:6px;
      background:rgba(255,165,0,.2);
      color:#ffa500;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      margin-left:8px;
    }
    .ai-price{
      font-size:14px;
      color:var(--muted);
      text-decoration:line-through;
      margin-left:12px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <div class="nav">
      <div class="nav-inner">
        <a href="/admin/dashboard" class="nav-back">‚Üê Dashboard</a>
        <div class="nav-center">Job #{{ token[:8] }}</div>
        <button onclick="showKeyboardShortcuts()" style="background:none; border:none; color:var(--text); opacity:.8; cursor:pointer;">‚åò</button>
      </div>
    </div>

    <div class="screen">
      <div class="largetitle">
        {% if job.status == 'awaiting_approval' %}
          ‚è≥ Review Quote
        {% elif job.status == 'approved' %}
          ‚úÖ Approved Quote
        {% elif job.status == 'rejected' %}
          ‚ùå Rejected Quote
        {% else %}
          üìã Quote Details
        {% endif %}
      </div>
      <p class="subtitle">
        {{ job.customer_name or 'Customer' }}
        {% if job.customer_email or job.customer_phone %}
          ‚Ä¢ {{ job.customer_email }}
          {% if job.customer_phone %}‚Ä¢ {{ job.customer_phone }}{% endif %}
        {% endif %}
      </p>

      <!-- Status Banner -->
      {% if job.status == 'awaiting_approval' %}
        <div class="group" style="background:rgba(255,165,0,.15); border-color:rgba(255,165,0,.3);">
          <div style="color:#ffa500; font-weight:700; text-align:center; font-size:16px;">
            ‚è≥ Awaiting Your Approval
          </div>
          {% if job.submitted_at %}
            <div style="text-align:center; margin-top:6px; font-size:13px; color:var(--muted);">
              Submitted <span id="timeAgo"></span>
            </div>
          {% endif %}
        </div>
      {% elif job.status == 'approved' %}
        <div class="group" style="background:rgba(46,229,157,.15); border-color:rgba(46,229,157,.3);">
          <div style="color:#2ee59d; font-weight:700; text-align:center; font-size:16px;">
            ‚úÖ Quote Approved
          </div>
        </div>
      {% elif job.status == 'rejected' %}
        <div class="group" style="background:rgba(255,77,79,.15); border-color:rgba(255,77,79,.3);">
          <div style="color:#ff4d4f; font-weight:700; text-align:center; font-size:16px;">
            ‚ùå Quote Rejected
          </div>
          {% if job.rejection_reason %}
            <div style="margin-top:8px; font-size:14px; color:var(--muted); text-align:center;">
              Reason: {{ job.rejection_reason }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      <!-- Quote Summary with Price Editing -->
      <div class="group">
        <div style="display:flex; justify-content:space-between; align-items:start;">
          <div style="flex:1;">
            <div class="bigprice">
              ¬£{{ quote.estimate_low }} ‚Äì ¬£{{ quote.estimate_high }}
              {% if quote.has_custom_price %}
                <span class="custom-price-badge">Custom Price</span>
              {% endif %}
            </div>
            {% if quote.has_custom_price %}
              <div class="ai-price">AI: ¬£{{ quote.ai_estimate_low }} ‚Äì ¬£{{ quote.ai_estimate_high }}</div>
            {% endif %}
            <div class="pill">{{ quote.confidence }}</div>
          </div>
          {% if job.status == 'awaiting_approval' %}
            <button onclick="togglePriceEdit()" class="btn secondary" style="margin:0; padding:10px 16px; font-size:13px;">
              ‚úèÔ∏è Edit Price
            </button>
          {% endif %}
        </div>

        <!-- Price Edit Form -->
        <div class="price-edit-form" id="priceEditForm">
          <form method="post" action="/admin/job/{{ token }}/update-price">
            <div style="font-weight:700; margin-bottom:12px;">Override AI Pricing</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
              <div>
                <label style="display:block; font-size:13px; margin-bottom:6px;">Low Estimate (¬£)</label>
                <input
                  type="number"
                  name="custom_price_low"
                  value="{{ quote.estimate_low }}"
                  required
                  style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--hair); background:rgba(255,255,255,.04); color:var(--text); font-size:15px;"
                />
              </div>
              <div>
                <label style="display:block; font-size:13px; margin-bottom:6px;">High Estimate (¬£)</label>
                <input
                  type="number"
                  name="custom_price_high"
                  value="{{ quote.estimate_high }}"
                  required
                  style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--hair); background:rgba(255,255,255,.04); color:var(--text); font-size:15px;"
                />
              </div>
            </div>
            <div style="display:flex; gap:8px;">
              <button type="submit" class="btn" style="margin:0; padding:10px 16px; font-size:13px;">
                üíæ Save New Price
              </button>
              <button type="button" onclick="togglePriceEdit()" class="btn secondary" style="margin:0; padding:10px 16px; font-size:13px;">
                Cancel
              </button>
            </div>
          </form>
        </div>

        <!-- Stats -->
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">Move Summary</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="statrow">
              <div class="staticon">üì¶</div>
              <div class="statrow-text">
                <span class="statrow-label">Total items</span>
                <span class="statrow-value">{{ quote.total_items }}</span>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon">üìê</div>
              <div class="statrow-text">
                <span class="statrow-label">Volume (CBM)</span>
                <span class="statrow-value">{{ quote.total_cbm }} m¬≥</span>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon">‚öñÔ∏è</div>
              <div class="statrow-text">
                <span class="statrow-label">Est. weight</span>
                <span class="statrow-value">{{ quote.total_weight_kg }} kg</span>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon">üèãÔ∏è</div>
              <div class="statrow-text">
                <span class="statrow-label">Bulky items</span>
                <span class="statrow-value">{{ quote.bulky_items }}</span>
              </div>
            </div>
            {% if quote.fragile_items > 0 %}
            <div class="statrow">
              <div class="staticon">‚ö†Ô∏è</div>
              <div class="statrow-text">
                <span class="statrow-label">Fragile items</span>
                <span class="statrow-value">{{ quote.fragile_items }}</span>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Pricing Breakdown -->
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">üí∞ AI Pricing Breakdown</div>
          <div style="display:flex; flex-direction:column; gap:8px; font-size:14px;">
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Base callout:</span>
              <strong>¬£{{ quote.breakdown.base }}</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Volume ({{ quote.total_cbm }} m¬≥ √ó ¬£35):</span>
              <strong>¬£{{ "%.2f"|format(quote.breakdown.volume) }}</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Bulky surcharge:</span>
              <strong>¬£{{ quote.breakdown.bulky }}</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Fragile surcharge:</span>
              <strong>¬£{{ quote.breakdown.fragile }}</strong>
            </div>
            {% if quote.breakdown.weight > 0 %}
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Weight surcharge:</span>
              <strong>¬£{{ "%.2f"|format(quote.breakdown.weight) }}</strong>
            </div>
            {% endif %}
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Distance:</span>
              <strong>¬£{{ quote.breakdown.distance }}</strong>
            </div>
          </div>
        </div>

        <!-- Route Info -->
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">Route</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="statrow">
              <div class="staticon" style="background:rgba(46,229,157,.15);">
                <span style="font-size:12px;">üìç</span>
              </div>
              <div style="flex:1; min-width:0;">
                <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Pickup</div>
                <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.pickup.label if job.pickup else "Not set" }}</div>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon" style="background:rgba(255,77,79,.15);">
                <span style="font-size:12px;">üìç</span>
              </div>
              <div style="flex:1; min-width:0;">
                <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Delivery</div>
                <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.dropoff.label if job.dropoff else "Not set" }}</div>
              </div>
            </div>
          </div>
        </div>

        {% if job.property_type %}
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:8px;">Property Type</div>
          <div style="font-size:15px;">{{ job.property_type }}</div>
        </div>
        {% endif %}

        {% if job.pickup_access or job.dropoff_access %}
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">üö™ Access Details</div>

          {% if job.pickup_access %}
          <div style="margin-bottom:16px; padding:14px; border-radius:12px; background:rgba(46,229,157,.08); border:1px solid rgba(46,229,157,.2);">
            <div style="font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
              <span style="color:#2ee59d;">üìç</span> Pickup Access
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; font-size:14px;">
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Floor & Lift</div>
                <div style="font-weight:600;">
                  {% if job.pickup_access.floors == 0 %}Ground floor{% else %}Floor {{ job.pickup_access.floors }}{% endif %}
                  {% if job.pickup_access.has_lift %} (Lift ‚úì){% else %} (No lift ‚ö†Ô∏è){% endif %}
                </div>
              </div>
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Parking</div>
                <div style="font-weight:600;">{{ job.pickup_access.parking_type|title|replace('_', ' ') }}</div>
                {% if job.pickup_access.parking_distance_meters %}
                <div style="font-size:12px; color:var(--muted);">{{ job.pickup_access.parking_distance_meters }}m from property</div>
                {% endif %}
              </div>
              {% if job.pickup_access.building_restrictions %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Restrictions</div>
                <div style="font-weight:600;">
                  {% for restriction in job.pickup_access.building_restrictions %}
                  <span style="display:inline-block; padding:3px 8px; background:rgba(255,165,0,.2); border-radius:6px; font-size:11px; margin-right:4px; margin-bottom:4px;">
                    {{ restriction|replace('_', ' ')|title }}
                  </span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              {% if job.pickup_access.outdoor_access != 'direct' %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Outdoor Access</div>
                <div style="font-weight:600;">{{ job.pickup_access.outdoor_access|title|replace('_', ' ') }}</div>
                {% if job.pickup_access.outdoor_steps %}
                <div style="font-size:12px; color:var(--muted);">{{ job.pickup_access.outdoor_steps }} steps</div>
                {% endif %}
              </div>
              {% endif %}
            </div>
            {% if job.pickup_access.notes %}
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(46,229,157,.2);">
              <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Notes</div>
              <div style="font-size:14px; font-style:italic;">{{ job.pickup_access.notes }}</div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          {% if job.dropoff_access %}
          <div style="padding:14px; border-radius:12px; background:rgba(255,77,79,.08); border:1px solid rgba(255,77,79,.2);">
            <div style="font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
              <span style="color:#ff4d4f;">üìç</span> Dropoff Access
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; font-size:14px;">
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Floor & Lift</div>
                <div style="font-weight:600;">
                  {% if job.dropoff_access.floors == 0 %}Ground floor{% else %}Floor {{ job.dropoff_access.floors }}{% endif %}
                  {% if job.dropoff_access.has_lift %} (Lift ‚úì){% else %} (No lift ‚ö†Ô∏è){% endif %}
                </div>
              </div>
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Parking</div>
                <div style="font-weight:600;">{{ job.dropoff_access.parking_type|title|replace('_', ' ') }}</div>
                {% if job.dropoff_access.parking_distance_meters %}
                <div style="font-size:12px; color:var(--muted);">{{ job.dropoff_access.parking_distance_meters }}m from property</div>
                {% endif %}
              </div>
              {% if job.dropoff_access.building_restrictions %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Restrictions</div>
                <div style="font-weight:600;">
                  {% for restriction in job.dropoff_access.building_restrictions %}
                  <span style="display:inline-block; padding:3px 8px; background:rgba(255,165,0,.2); border-radius:6px; font-size:11px; margin-right:4px; margin-bottom:4px;">
                    {{ restriction|replace('_', ' ')|title }}
                  </span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              {% if job.dropoff_access.outdoor_access != 'direct' %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Outdoor Access</div>
                <div style="font-weight:600;">{{ job.dropoff_access.outdoor_access|title|replace('_', ' ') }}</div>
                {% if job.dropoff_access.outdoor_steps %}
                <div style="font-size:12px; color:var(--muted);">{{ job.dropoff_access.outdoor_steps }} steps</div>
                {% endif %}
              </div>
              {% endif %}
            </div>
            {% if job.dropoff_access.notes %}
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,77,79,.2);">
              <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Notes</div>
              <div style="font-size:14px; font-style:italic;">{{ job.dropoff_access.notes }}</div>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}

        {% if packing_breakdown and breakdown.packing and breakdown.packing > 0 %}
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">üì¶ Packing Materials Required</div>
          <div style="padding:14px; border-radius:12px; background:rgba(46,229,157,.08); border:1px solid rgba(46,229,157,.2);">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; font-size:14px;">
              {% if packing_breakdown.small_boxes.qty > 0 %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Small Boxes (18√ó18√ó10")</div>
                <div style="font-weight:600;">{{ packing_breakdown.small_boxes.qty }} boxes - ¬£{{ "%.2f"|format(packing_breakdown.small_boxes.cost) }}</div>
              </div>
              {% endif %}
              {% if packing_breakdown.medium_boxes.qty > 0 %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Medium Boxes (18√ó18√ó20")</div>
                <div style="font-weight:600;">{{ packing_breakdown.medium_boxes.qty }} boxes - ¬£{{ "%.2f"|format(packing_breakdown.medium_boxes.cost) }}</div>
              </div>
              {% endif %}
              {% if packing_breakdown.large_boxes.qty > 0 %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Large Boxes (18√ó18√ó30")</div>
                <div style="font-weight:600;">{{ packing_breakdown.large_boxes.qty }} boxes - ¬£{{ "%.2f"|format(packing_breakdown.large_boxes.cost) }}</div>
              </div>
              {% endif %}
              {% if packing_breakdown.robe_cartons.qty > 0 %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Wardrobe Cartons</div>
                <div style="font-weight:600;">{{ packing_breakdown.robe_cartons.qty }} cartons - ¬£{{ "%.2f"|format(packing_breakdown.robe_cartons.cost) }}</div>
              </div>
              {% endif %}
              {% if packing_breakdown.mattress_covers.qty > 0 %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Mattress Covers</div>
                <div style="font-weight:600;">{{ packing_breakdown.mattress_covers.qty }} covers - ¬£{{ "%.2f"|format(packing_breakdown.mattress_covers.cost) }}</div>
              </div>
              {% endif %}
              <div>
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Tape & Paper</div>
                <div style="font-weight:600;">{{ packing_breakdown.tape_rolls.qty }} rolls, {{ packing_breakdown.paper_packs.qty }} packs</div>
              </div>
              <div style="grid-column: 1 / -1; padding-top:10px; border-top:1px solid rgba(46,229,157,.2); margin-top:8px;">
                <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Total Packing Cost</div>
                <div style="font-weight:700; font-size:18px; color:#2ee59d;">¬£{{ "%.2f"|format(breakdown.packing) }}</div>
              </div>
            </div>
          </div>

          {% if job.customer_provides_packing %}
          <div style="margin-top:12px; padding:12px; border-radius:8px; background:rgba(255,165,0,.1); border:1px solid rgba(255,165,0,.3);">
            <div style="font-size:13px; color:#ffa500; font-weight:600;">
              ‚ö†Ô∏è Customer Bringing Own Materials
            </div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
              Customer will provide their own packing materials. Ensure they have everything listed above.
            </div>
          </div>
          {% else %}
          <div style="margin-top:12px; padding:12px; border-radius:8px; background:rgba(46,229,157,.1); border:1px solid rgba(46,229,157,.3);">
            <div style="font-size:13px; color:#2ee59d; font-weight:600;">
              ‚úì Company Providing Materials
            </div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
              We will provide all packing materials listed above.
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        {% if packing_service_breakdown and packing_service_breakdown.total_cost > 0 %}
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">üë∑ Packing Service Requested</div>
          <div style="padding:14px; border-radius:12px; background:rgba(46,229,157,.08); border:1px solid rgba(46,229,157,.2);">
            <div style="margin-bottom:12px;">
              <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Customer wants professional packing for:</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                {% for room in packing_service_breakdown.rooms %}
                  {% if room.is_selected %}
                  <div style="padding:10px; background:rgba(255,255,255,.05); border-radius:8px; border:1px solid rgba(255,255,255,.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <div>
                        <div style="font-weight:600;">{{ room.room_name }}</div>
                        <div style="font-size:12px; color:var(--muted);">{{ room.items_count }} items ‚Ä¢ ~{{ room.hours }}h packing</div>
                      </div>
                      <div style="font-weight:700; color:#2ee59d;">¬£{{ "%.0f"|format(room.cost) }}</div>
                    </div>
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            <div style="padding-top:12px; border-top:1px solid rgba(46,229,157,.2); margin-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="color:var(--muted); font-size:12px; margin-bottom:3px;">Total Packing Service</div>
                  <div style="font-size:12px; color:var(--muted);">{{ packing_service_breakdown.total_hours }}h labor (materials included)</div>
                </div>
                <div style="font-weight:700; font-size:18px; color:#2ee59d;">¬£{{ "%.0f"|format(packing_service_breakdown.total_cost) }}</div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Admin Notes -->
      <div class="group">
        <div style="font-weight:700; margin-bottom:12px;">üìù Internal Notes</div>

        {% if job.admin_notes and job.admin_notes|length > 0 %}
          <div class="notes-section">
            {% for note in job.admin_notes %}
              <div class="note-item">
                <div class="note-time">{{ note.timestamp[:16].replace('T', ' ') }}</div>
                <div class="note-text">{{ note.note }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="text-align:center; padding:20px; color:var(--muted); font-size:14px;">
            No notes yet
          </div>
        {% endif %}

        <form method="post" action="/admin/job/{{ token }}/add-note" style="margin-top:12px;">
          <textarea
            name="note"
            placeholder="Add internal note (not visible to customer)..."
            rows="3"
            style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--hair); background:rgba(255,255,255,.04); color:var(--text); font-size:14px; font-family:inherit; resize:vertical;"
          ></textarea>
          <button type="submit" class="btn secondary" style="margin-top:8px; padding:10px 16px; font-size:13px;">
            üíæ Add Note
          </button>
        </form>
      </div>

      <!-- Rooms & Items -->
      {% if job.rooms and job.rooms|length > 0 %}
        <div class="group">
          <div class="rowhead">
            <div class="rowtitle">üì¶ Inventory</div>
            <div class="rowsub">{{ job.rooms|length }} rooms</div>
          </div>

          <div class="invlist">
            {% for room in job.rooms %}
              <div style="padding:14px; border-radius:14px; border:1px solid var(--hair); background:rgba(255,255,255,.02); margin-bottom:10px;">
                <div style="font-weight:700; margin-bottom:8px;">{{ room.name }}</div>

                {% if room.photos and room.photos|length > 0 %}
                  <div class="photogrid" style="margin-bottom:12px;">
                    {% for photo in room.photos[:6] %}
                      <div class="photo photo-thumb" onclick="openLightbox('{{ photo.url }}')">
                        <img class="photoimg" src="{{ photo.url }}" alt="Photo" loading="lazy" />
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if room.items and room.items|length > 0 %}
                  <div style="font-size:13px; color:var(--muted); margin-bottom:6px;">{{ room.items|length }} items detected:</div>
                  <div class="itemslist">
                    {% for item in room.items %}
                      <div class="itemrow">
                        <div class="iteminfo">
                          <div class="itemname">{{ item.qty }}x {{ item.name }}</div>
                          {% if item.notes %}
                            <div class="itemnotes">{{ item.notes }}</div>
                          {% endif %}
                          <div class="itemnotes">
                            {{ item.length_cm }}√ó{{ item.width_cm }}√ó{{ item.height_cm }}cm
                            ‚Ä¢ {{ item.weight_kg }}kg
                            ‚Ä¢ {{ item.cbm }} m¬≥
                          </div>
                        </div>
                        {% if item.bulky %}
                          <span class="badge">Bulky</span>
                        {% endif %}
                        {% if item.fragile %}
                          <span class="badge" style="background:rgba(255,165,0,.15); color:#ffa500;">Fragile</span>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div style="font-size:13px; color:var(--muted);">No items detected yet</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Action Buttons -->
    {% if job.status == 'awaiting_approval' %}
      <div class="footer footer-clean">
        <div class="footer-inner">
          <form method="post" action="/admin/job/{{ token }}/approve">
            <button class="btn" type="submit" style="background:#2ee59d; color:#000;">
              ‚úÖ Approve Quote <kbd style="margin-left:8px; opacity:.7;">A</kbd>
            </button>
          </form>

          <button class="btn secondary" type="button" id="rejectBtn" style="margin-top:10px;">
            ‚ùå Reject Quote <kbd style="margin-left:8px; opacity:.7;">R</kbd>
          </button>
        </div>
      </div>

      <!-- Reject Modal -->
      <div id="rejectModal" class="overlay" style="display:none;">
        <div class="modal">
          <div class="modal-title">Reject Quote</div>
          <form method="post" action="/admin/job/{{ token }}/reject">
            <div style="margin:12px 0;">
              <label for="reason" style="display:block; font-weight:600; margin-bottom:8px; font-size:14px;">
                Reason (optional)
              </label>
              <textarea
                id="reason"
                name="reason"
                rows="3"
                placeholder="e.g., Need clearer photos of heavy items"
                style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--hair); background:rgba(255,255,255,.04); color:var(--text); font-size:14px; font-family:inherit; resize:vertical;"
              ></textarea>
            </div>

            <button class="btn" type="submit" style="background:#ff4d4f; color:#fff;">
              Confirm Rejection
            </button>
            <button class="btn secondary" type="button" id="cancelBtn" style="margin-top:10px;">
              Cancel
            </button>
          </form>
        </div>
      </div>
    {% else %}
      <div class="footer footer-clean">
        <div class="footer-inner">
          <a href="/admin/dashboard" class="btn secondary">
            ‚Üê Back to Dashboard
          </a>
        </div>
      </div>
    {% endif %}

    <!-- Photo Lightbox -->
    <div class="lightbox" id="lightbox">
      <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
      <img class="lightbox-img" id="lightboxImg" src="" alt="Photo" />
    </div>
  </div>

  <script>
    // Price editing
    function togglePriceEdit() {
      const form = document.getElementById('priceEditForm');
      form.classList.toggle('active');
    }

    // Reject modal
    const rejectBtn = document.getElementById('rejectBtn');
    const modal = document.getElementById('rejectModal');
    const cancelBtn = document.getElementById('cancelBtn');

    if (rejectBtn) {
      rejectBtn.addEventListener('click', () => modal.style.display = 'flex');
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => modal.style.display = 'none');
    }
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    }

    // Photo lightbox
    function openLightbox(src) {
      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      img.src = src;
      lightbox.classList.add('active');
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      lightbox.classList.remove('active');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // ESC to close modals/lightbox
      if (e.key === 'Escape') {
        closeLightbox();
        if (modal) modal.style.display = 'none';
        e.preventDefault();
      }

      {% if job.status == 'awaiting_approval' %}
      // 'A' to approve
      if (e.key === 'a' && !e.metaKey && !e.ctrlKey && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
        document.querySelector('form[action*="approve"] button').click();
        e.preventDefault();
      }

      // 'R' to reject
      if (e.key === 'r' && !e.metaKey && !e.ctrlKey && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
        rejectBtn.click();
        e.preventDefault();
      }

      // 'E' to edit price
      if (e.key === 'e' && !e.metaKey && !e.ctrlKey && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
        togglePriceEdit();
        e.preventDefault();
      }
      {% endif %}
    });

    function showKeyboardShortcuts() {
      alert('Keyboard Shortcuts:\\n\\nA - Approve quote\\nR - Reject quote\\nE - Edit price\\nESC - Close modals\\n? - Show this help');
    }

    // Time ago calculator
    {% if job.submitted_at %}
    function updateTimeAgo() {
      const submitted = new Date('{{ job.submitted_at }}');
      const now = new Date();
      const diff = Math.floor((now - submitted) / 1000 / 60); // minutes

      let text = '';
      if (diff < 1) text = 'just now';
      else if (diff < 60) text = `${diff} min ago`;
      else if (diff < 1440) text = `${Math.floor(diff/60)} hours ago`;
      else text = `${Math.floor(diff/1440)} days ago`;

      const el = document.getElementById('timeAgo');
      if (el) el.textContent = text;
    }

    updateTimeAgo();
    setInterval(updateTimeAgo, 60000); // Update every minute
    {% endif %}
  </script>
</body>
</html>
