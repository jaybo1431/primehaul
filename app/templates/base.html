<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover, user-scalable=yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0b0b0c" id="themeColor" />
    <meta name="apple-mobile-web-app-title" content="primehaul" />

    <title>{{ title or "primehaul" }}</title>
    <link rel="stylesheet" href="/static/app.css?v=8" />
    <script>
      // Apply theme immediately to prevent flash
      (function(){
        var stored = localStorage.getItem('ph-theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = stored || (prefersDark ? 'dark' : 'light');
        if(theme === 'light') {
          document.documentElement.classList.add('light-mode');
          document.body && document.body.classList.add('light-mode');
        }
      })();
    </script>
  </head>

  <body>
    <div class="app">
      <header class="nav">
        <div class="nav-inner">
          {% if back_url %}
            <a class="nav-back" href="{{ back_url }}" aria-label="Back">‚Äπ Back</a>
          {% else %}
            <span class="nav-back ghost" aria-hidden="true">‚Äπ Back</span>
          {% endif %}

          <div class="nav-center">
            {{ nav_title if nav_title else "primehaul" }}
          </div>

          <button class="voice-toggle" id="voiceToggle" aria-label="Toggle voice guide" title="Voice guide">
            <span class="voice-icon">üîá</span>
            <span class="voice-label">Voice</span>
          </button>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle light/dark mode" title="Toggle theme">
            <span class="theme-icon">üåô</span>
          </button>
        </div>

        {% if progress is not none %}
          <div class="nav-progress" aria-label="Progress">
            <div class="nav-progress-inner">
              <div class="nav-progress-bar" data-progress="{{ progress|default(0) }}"></div>
            </div>
          </div>
        {% endif %}
      </header>

      <main class="screen" role="main">
        {% block content %}{% endblock %}
      </main>

      {% block footer %}{% endblock %}
    </div>

    <script>
      (function () {
        // Prevent accidental double submits on mobile
        document.addEventListener(
          "submit",
          function (e) {
            const btn = e.target.querySelector('button[type="submit"]');
            if (btn) {
              btn.disabled = true;
              btn.classList.add("is-busy");
            }
          },
          true
        );

        // Progress bar width (avoid inline style with Jinja)
        const bar = document.querySelector(".nav-progress-bar[data-progress]");
        if (bar) {
          const p = Number(bar.getAttribute("data-progress") || "0");
          const clamped = Math.max(0, Math.min(100, p));
          bar.style.width = clamped + "%";
        }

        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle ? themeToggle.querySelector('.theme-icon') : null;
        const themeColor = document.getElementById('themeColor');

        function getStoredTheme() {
          return localStorage.getItem('ph-theme');
        }

        function getSystemTheme() {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function getCurrentTheme() {
          return getStoredTheme() || getSystemTheme();
        }

        function applyTheme(theme) {
          if (theme === 'light') {
            document.documentElement.classList.add('light-mode');
            document.body.classList.add('light-mode');
            if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            if (themeColor) themeColor.setAttribute('content', '#f5f5f7');
          } else {
            document.documentElement.classList.remove('light-mode');
            document.body.classList.remove('light-mode');
            if (themeIcon) themeIcon.textContent = 'üåô';
            if (themeColor) themeColor.setAttribute('content', '#0b0b0c');
          }
        }

        function toggleTheme() {
          const current = getCurrentTheme();
          const next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem('ph-theme', next);
          applyTheme(next);
        }

        // Initialize theme
        applyTheme(getCurrentTheme());

        // Toggle button click
        if (themeToggle) {
          themeToggle.addEventListener('click', toggleTheme);
        }

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          if (!getStoredTheme()) {
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });

        // =============================================
        // VOICE GUIDE FUNCTIONALITY (OpenAI TTS)
        // =============================================
        const voiceToggle = document.getElementById('voiceToggle');
        const voiceIcon = voiceToggle ? voiceToggle.querySelector('.voice-icon') : null;
        const voiceLabel = voiceToggle ? voiceToggle.querySelector('.voice-label') : null;
        let voiceEnabled = localStorage.getItem('ph-voice-guide') === 'true';
        let currentAudio = null;
        let isSpeaking = false;

        function updateVoiceUI(loading) {
          if (voiceIcon) {
            if (loading) {
              voiceIcon.textContent = '‚è≥';
            } else {
              voiceIcon.textContent = voiceEnabled ? 'üîä' : 'üîá';
            }
          }
          if (voiceLabel) {
            voiceLabel.textContent = voiceEnabled ? 'ON' : 'Voice';
          }
          if (voiceToggle) {
            voiceToggle.title = voiceEnabled ? 'Voice guide is ON - tap to turn off' : 'Tap to enable voice guide';
            if (voiceEnabled) {
              voiceToggle.classList.add('voice-on');
            } else {
              voiceToggle.classList.remove('voice-on');
            }
          }
        }

        async function speak(text) {
          if (!voiceEnabled || !text || isSpeaking) return;

          // Stop any currently playing audio
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }

          try {
            isSpeaking = true;
            updateVoiceUI(true); // Show loading

            // Call OpenAI TTS API
            const response = await fetch('/api/speak', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: text })
            });

            if (!response.ok) {
              throw new Error('TTS request failed');
            }

            // Create audio from response
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            currentAudio = new Audio(audioUrl);

            currentAudio.onended = function() {
              isSpeaking = false;
              updateVoiceUI(false);
              URL.revokeObjectURL(audioUrl);
            };

            currentAudio.onerror = function() {
              isSpeaking = false;
              updateVoiceUI(false);
            };

            updateVoiceUI(false);
            await currentAudio.play();

          } catch (err) {
            console.error('Voice guide error:', err);
            isSpeaking = false;
            updateVoiceUI(false);
          }
        }

        function stopSpeaking() {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }
          isSpeaking = false;
          updateVoiceUI(false);
        }

        function toggleVoice() {
          voiceEnabled = !voiceEnabled;
          localStorage.setItem('ph-voice-guide', voiceEnabled ? 'true' : 'false');
          localStorage.setItem('ph-voice-decided', 'true'); // Mark as decided
          updateVoiceUI(false);

          if (voiceEnabled) {
            // Speak page guidance directly - more useful than generic intro
            speakPageGuidance();
          } else {
            stopSpeaking();
          }
        }

        function speakPageGuidance() {
          if (!voiceEnabled) return;

          // Look for page-specific voice guidance
          const guidanceEl = document.getElementById('voiceGuidance');
          if (guidanceEl && guidanceEl.dataset.message) {
            speak(guidanceEl.dataset.message);
          }
        }

        // Initialize voice
        updateVoiceUI(false);

        if (voiceToggle) {
          voiceToggle.addEventListener('click', toggleVoice);
        }

        // Speak page guidance on load if voice is enabled
        if (voiceEnabled) {
          setTimeout(speakPageGuidance, 800);
        }

        // Make speak function globally available for page-specific triggers
        window.phSpeak = speak;
        window.phVoiceEnabled = function() { return voiceEnabled; };
        window.phStopSpeaking = stopSpeaking;
      })();
    </script>
  </body>
</html>
