{% extends "base.html" %}

{% block content %}
  <div class="largetitle">‚ú® Get Your Quote</div>
  <p class="subtitle">Professional moving quote in 3 minutes ‚Äî just answer a few questions and snap some photos.</p>

  <form id="startForm" method="post" action="/s/{{ company_slug }}/{{ token }}/start-v2">
    <!-- Step 1: Addresses -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">üìç Where are you moving?</div>

      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px; color:var(--muted);">
          Pickup address
        </label>
        <div style="position:relative;">
          <input
            type="text"
            id="pickup-input"
            name="pickup_label"
            class="form-input"
            placeholder="Enter or speak your current address..."
            autocomplete="off"
            required
            value="{{ job.pickup.label if job and job.pickup else '' }}"
          />
          <button type="button" id="pickup-voice-btn" class="voice-btn" title="Click to speak address">
            üé§
          </button>
        </div>
        <input type="hidden" id="pickup-lat" name="pickup_lat" value="{{ job.pickup.lat if job and job.pickup else '' }}" />
        <input type="hidden" id="pickup-lng" name="pickup_lng" value="{{ job.pickup.lng if job and job.pickup else '' }}" />
        <div id="pickup-suggestions" class="suggestions-dropdown"></div>
      </div>

      <div>
        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px; color:var(--muted);">
          Delivery address
        </label>
        <div style="position:relative;">
          <input
            type="text"
            id="dropoff-input"
            name="dropoff_label"
            class="form-input"
            placeholder="Enter or speak your new address..."
            autocomplete="off"
            required
            value="{{ job.dropoff.label if job and job.dropoff else '' }}"
          />
          <button type="button" id="dropoff-voice-btn" class="voice-btn" title="Click to speak address">
            üé§
          </button>
        </div>
        <input type="hidden" id="dropoff-lat" name="dropoff_lat" value="{{ job.dropoff.lat if job and job.dropoff else '' }}" />
        <input type="hidden" id="dropoff-lng" name="dropoff_lng" value="{{ job.dropoff.lng if job and job.dropoff else '' }}" />
        <div id="dropoff-suggestions" class="suggestions-dropdown"></div>
      </div>
    </div>

    <!-- Step 2: Property Type -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">üè† What type of property?</div>
      <div class="property-grid">
        <label class="property-card">
          <input type="radio" name="property_type" value="studio_flat" required {% if job and job.property_type == 'studio_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üö™</div>
            <div class="property-name">Studio</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="1_bed_flat" {% if job and job.property_type == '1_bed_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üõèÔ∏è</div>
            <div class="property-name">1 Bed Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="2_bed_flat" {% if job and job.property_type == '2_bed_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè¢</div>
            <div class="property-name">2 Bed Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="3_bed_flat" {% if job and job.property_type == '3_bed_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè¢</div>
            <div class="property-name">3 Bed Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="2_bed_house" {% if job and job.property_type == '2_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè°</div>
            <div class="property-name">2 Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="3_bed_house" {% if job and job.property_type == '3_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè°</div>
            <div class="property-name">3 Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="4_bed_house" {% if job and job.property_type == '4_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè†</div>
            <div class="property-name">4 Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="5_bed_house" {% if job and job.property_type == '5_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè∞</div>
            <div class="property-name">5+ Bed House</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Step 3: Move Date (Optional but helpful) -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">üìÖ When are you moving? <span style="font-weight:400; color:var(--muted);">(Optional)</span></div>
      <input
        type="date"
        name="move_date"
        class="form-input"
        min="{{ today }}"
        value="{{ job.move_date.strftime('%Y-%m-%d') if job and job.move_date else '' }}"
      />
      <div class="microhint" style="margin-top:6px;">Helps us check availability and plan your move</div>
    </div>
  </form>

  <script>
    // Mapbox address autocomplete
    const MAPBOX_TOKEN = "{{ mapbox_token }}";

    function setupAddressAutocomplete(inputId, suggestionsId, latFieldId, lngFieldId) {
      const input = document.getElementById(inputId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      const latField = document.getElementById(latFieldId);
      const lngField = document.getElementById(lngFieldId);

      let debounceTimer;

      input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const query = input.value.trim();

        if (query.length < 3) {
          suggestionsDiv.innerHTML = '';
          suggestionsDiv.style.display = 'none';
          return;
        }

        debounceTimer = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&country=GB&types=address,postcode&limit=5`
            );
            const data = await response.json();

            if (data.features && data.features.length > 0) {
              suggestionsDiv.innerHTML = data.features.map(feature =>
                `<div class="suggestion-item" data-lat="${feature.center[1]}" data-lng="${feature.center[0]}" data-label="${feature.place_name}">
                  <div style="font-weight:600;">${feature.text}</div>
                  <div style="font-size:12px; color:var(--muted);">${feature.place_name}</div>
                </div>`
              ).join('');
              suggestionsDiv.style.display = 'block';

              // Add click handlers
              suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                  input.value = item.dataset.label;
                  latField.value = item.dataset.lat;
                  lngField.value = item.dataset.lng;
                  suggestionsDiv.innerHTML = '';
                  suggestionsDiv.style.display = 'none';
                });
              });
            } else {
              suggestionsDiv.innerHTML = '';
              suggestionsDiv.style.display = 'none';
            }
          } catch (err) {
            console.error('Geocoding error:', err);
          }
        }, 300);
      });

      // Close suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          suggestionsDiv.style.display = 'none';
        }
      });
    }

    setupAddressAutocomplete('pickup-input', 'pickup-suggestions', 'pickup-lat', 'pickup-lng');
    setupAddressAutocomplete('dropoff-input', 'dropoff-suggestions', 'dropoff-lat', 'dropoff-lng');

    // Voice input functionality
    function setupVoiceInput(btnId, inputId) {
      const btn = document.getElementById(btnId);
      const input = document.getElementById(inputId);

      // Check if browser supports speech recognition
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        btn.style.display = 'none'; // Hide button if not supported
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = 'en-GB';
      recognition.continuous = false;
      recognition.interimResults = false;

      btn.addEventListener('click', () => {
        btn.textContent = 'üî¥';
        btn.classList.add('listening');
        recognition.start();
      });

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        input.dispatchEvent(new Event('input', { bubbles: true })); // Trigger autocomplete
        btn.textContent = 'üé§';
        btn.classList.remove('listening');
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        btn.textContent = 'üé§';
        btn.classList.remove('listening');
        if (event.error === 'no-speech') {
          alert('No speech detected. Please try again.');
        } else if (event.error === 'not-allowed') {
          alert('Microphone access denied. Please enable microphone permissions.');
        }
      };

      recognition.onend = () => {
        btn.textContent = 'üé§';
        btn.classList.remove('listening');
      };
    }

    setupVoiceInput('pickup-voice-btn', 'pickup-input');
    setupVoiceInput('dropoff-voice-btn', 'dropoff-input');
  </script>

  <style>
    .form-input {
      width: 100%;
      padding: 14px 48px 14px 16px; /* Extra padding on right for voice button */
      font-size: 15px;
      border: 1.5px solid var(--hair);
      border-radius: 12px;
      background: var(--bg);
      color: var(--text);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #2ee59d;
      background: rgba(46,229,157,.05);
    }

    .voice-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(46,229,157,.15);
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .voice-btn:hover {
      background: rgba(46,229,157,.25);
      transform: translateY(-50%) scale(1.05);
    }

    .voice-btn.listening {
      background: rgba(255,77,79,.3);
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
    }

    .suggestions-dropdown {
      position: relative;
      margin-top: 8px;
      background: var(--bg);
      border: 1.5px solid var(--hair);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid var(--hair);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background: rgba(46,229,157,.1);
    }

    .property-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .property-card {
      cursor: pointer;
      position: relative;
    }

    .property-card input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .property-card-content {
      padding: 16px;
      border: 2px solid var(--hair);
      border-radius: 12px;
      text-align: center;
      transition: all 0.2s;
      background: var(--bg);
    }

    .property-card input:checked + .property-card-content {
      border-color: #2ee59d;
      background: rgba(46,229,157,.1);
    }

    .property-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .property-name {
      font-size: 13px;
      font-weight: 600;
    }

    @media (max-width: 480px) {
      .property-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .property-icon {
        font-size: 28px;
      }

      .property-name {
        font-size: 12px;
      }
    }
  </style>
{% endblock %}

{% block footer %}
  <div class="footer footer-clean">
    <div class="footer-inner">
      <button class="btn ready" type="submit" form="startForm">Continue ‚Üí</button>
      <div class="microhint" style="text-align:center; margin-top:8px;">Takes 2-3 minutes ‚Ä¢ No signup required</div>
    </div>
  </div>
{% endblock %}
