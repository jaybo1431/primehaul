{% extends "base.html" %}

{% block content %}
  <!-- Voice guidance - speaks immediately on first load -->
  <div id="voiceGuidance" data-message="Hey there! Let's get you a quick moving quote. Pop in the address you're moving from, and where you're heading to. You'll see them appear on the map. Then pick what type of property you're collecting from, and what you're delivering to. If you know your moving date, add that too. Then hit Continue at the bottom!" hidden></div>

  {% if is_survey %}
  <div class="largetitle">Moving survey</div>
  <p class="subtitle">Help us catalog your items.</p>
  {% else %}
  <div class="largetitle">Get an instant quote</div>
  <p class="subtitle">3 minutes. No signup required.</p>
  {% endif %}

  <form id="startForm" method="post" action="/s/{{ company_slug }}/{{ token }}/start-v2">
    <!-- Addresses with live map -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">Move locations</div>

      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px; color:var(--muted);">
          <span class="addr-dot addr-dot-pickup"></span> Pickup address
        </label>
        <input
          type="text"
          id="pickup-input"
          name="pickup_label"
          class="form-input"
          placeholder="Enter your current address..."
          autocomplete="off"
          required
          value="{{ job.pickup.label if job and job.pickup else '' }}"
        />
        <input type="hidden" id="pickup-lat" name="pickup_lat" value="{{ job.pickup.lat if job and job.pickup else '' }}" />
        <input type="hidden" id="pickup-lng" name="pickup_lng" value="{{ job.pickup.lng if job and job.pickup else '' }}" />
        <div id="pickup-suggestions" class="suggestions-dropdown"></div>
      </div>

      <div>
        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px; color:var(--muted);">
          <span class="addr-dot addr-dot-dropoff"></span> Delivery address
        </label>
        <input
          type="text"
          id="dropoff-input"
          name="dropoff_label"
          class="form-input"
          placeholder="Enter your new address..."
          autocomplete="off"
          required
          value="{{ job.dropoff.label if job and job.dropoff else '' }}"
        />
        <input type="hidden" id="dropoff-lat" name="dropoff_lat" value="{{ job.dropoff.lat if job and job.dropoff else '' }}" />
        <input type="hidden" id="dropoff-lng" name="dropoff_lng" value="{{ job.dropoff.lng if job and job.dropoff else '' }}" />
        <div id="dropoff-suggestions" class="suggestions-dropdown"></div>
      </div>

      <!-- Live mini map -->
      <div id="miniMapWrap" class="mini-map-wrap">
        <div id="miniMap" class="mini-map"></div>
      </div>
    </div>

    <!-- Step 2: Collection Property Type -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">Collecting from</div>
      <div class="property-grid">
        <label class="property-card">
          <input type="radio" name="property_type" value="studio_flat" required {% if job and job.property_type == 'studio_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üö™</div>
            <div class="property-name">Studio</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="1_bed_flat" {% if job and job.property_type == '1_bed_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üõèÔ∏è</div>
            <div class="property-name">1 Bed Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="2_bed_flat" {% if job and job.property_type == '2_bed_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè¢</div>
            <div class="property-name">2 Bed Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="3_bed_flat" {% if job and job.property_type == '3_bed_flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè¢</div>
            <div class="property-name">3 Bed Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="2_bed_house" {% if job and job.property_type == '2_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè°</div>
            <div class="property-name">2 Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="3_bed_house" {% if job and job.property_type == '3_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè°</div>
            <div class="property-name">3 Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="4_bed_house" {% if job and job.property_type == '4_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè†</div>
            <div class="property-name">4 Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="5_bed_house" {% if job and job.property_type == '5_bed_house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè∞</div>
            <div class="property-name">5+ Bed House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="bungalow" {% if job and job.property_type == 'bungalow' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üèòÔ∏è</div>
            <div class="property-name">Bungalow</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="property_type" value="office" {% if job and job.property_type == 'office' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üíº</div>
            <div class="property-name">Office</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Step 2b: Delivery Property Type -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">Delivering to</div>
      <div class="property-grid">
        <label class="property-card">
          <input type="radio" name="dropoff_property_type" value="house" required {% if job and job.dropoff_property_type == 'house' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè†</div>
            <div class="property-name">House</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="dropoff_property_type" value="bungalow" {% if job and job.dropoff_property_type == 'bungalow' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üèòÔ∏è</div>
            <div class="property-name">Bungalow</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="dropoff_property_type" value="flat" {% if job and job.dropoff_property_type == 'flat' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üè¢</div>
            <div class="property-name">Flat</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="dropoff_property_type" value="office" {% if job and job.dropoff_property_type == 'office' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üíº</div>
            <div class="property-name">Office</div>
          </div>
        </label>
        <label class="property-card">
          <input type="radio" name="dropoff_property_type" value="storage" {% if job and job.dropoff_property_type == 'storage' %}checked{% endif %} />
          <div class="property-card-content">
            <div class="property-icon">üì¶</div>
            <div class="property-name">Storage</div>
          </div>
        </label>
      </div>
      <div class="microhint" style="margin-top:8px;">Helps us plan for stairs, lifts and parking</div>
    </div>

    <!-- Step 3: Move Date (Optional but helpful) -->
    <div class="group">
      <div style="font-weight:700; margin-bottom:12px;">Move date <span style="font-weight:400; color:var(--muted);">(Optional)</span></div>
      <input
        type="date"
        name="move_date"
        class="form-input"
        min="{{ today }}"
        value="{{ job.move_date.strftime('%Y-%m-%d') if job and job.move_date else '' }}"
      />
      <div class="microhint" style="margin-top:6px;">Helps us check availability</div>
    </div>
  </form>

  <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>

  <script>
    // Mapbox address autocomplete + live map
    const MAPBOX_TOKEN = "{{ mapbox_token }}";

    // ---- Live mini map ----
    let miniMap = null;
    let pickupMarker = null;
    let dropoffMarker = null;
    let routeLine = null;

    function initMiniMap() {
      if (!MAPBOX_TOKEN || miniMap) return;

      mapboxgl.accessToken = MAPBOX_TOKEN;
      miniMap = new mapboxgl.Map({
        container: 'miniMap',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [-1.5, 53.0],
        zoom: 5.2,
        interactive: false,
        attributionControl: false
      });

      miniMap.on('load', function() {
        // Add route line source (empty initially)
        miniMap.addSource('route', {
          type: 'geojson',
          data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [] } }
        });
        miniMap.addLayer({
          id: 'route-line',
          type: 'line',
          source: 'route',
          paint: {
            'line-color': '#2ee59d',
            'line-width': 2.5,
            'line-dasharray': [3, 2],
            'line-opacity': 0.7
          }
        });

        // If addresses already filled (coming back to page)
        tryPreloadMarkers();
      });
    }

    function tryPreloadMarkers() {
      var pLat = document.getElementById('pickup-lat').value;
      var pLng = document.getElementById('pickup-lng').value;
      var dLat = document.getElementById('dropoff-lat').value;
      var dLng = document.getElementById('dropoff-lng').value;

      if (pLat && pLng) updateMapMarker('pickup', parseFloat(pLng), parseFloat(pLat));
      if (dLat && dLng) updateMapMarker('dropoff', parseFloat(dLng), parseFloat(dLat));
    }

    function createMarkerEl(type) {
      var el = document.createElement('div');
      el.className = 'map-pin map-pin-' + type;
      el.innerHTML = type === 'pickup' ? 'A' : 'B';
      return el;
    }

    function updateMapMarker(type, lng, lat) {
      if (!miniMap) return;

      var mapWrap = document.getElementById('miniMapWrap');
      if (mapWrap) mapWrap.classList.add('map-visible');

      if (type === 'pickup') {
        if (pickupMarker) pickupMarker.remove();
        pickupMarker = new mapboxgl.Marker({ element: createMarkerEl('pickup') })
          .setLngLat([lng, lat])
          .addTo(miniMap);
      } else {
        if (dropoffMarker) dropoffMarker.remove();
        dropoffMarker = new mapboxgl.Marker({ element: createMarkerEl('dropoff') })
          .setLngLat([lng, lat])
          .addTo(miniMap);
      }

      // Update route line and fit bounds if both markers exist
      if (pickupMarker && dropoffMarker) {
        var pCoords = pickupMarker.getLngLat();
        var dCoords = dropoffMarker.getLngLat();

        miniMap.getSource('route')?.setData({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [[pCoords.lng, pCoords.lat], [dCoords.lng, dCoords.lat]]
          }
        });

        miniMap.fitBounds(
          [[pCoords.lng, pCoords.lat], [dCoords.lng, dCoords.lat]],
          { padding: 50, duration: 800, maxZoom: 12 }
        );
      } else {
        miniMap.flyTo({ center: [lng, lat], zoom: 11, duration: 600 });
      }
    }

    // Initialize map
    if (MAPBOX_TOKEN) initMiniMap();

    // ---- Address autocomplete ----
    function setupAddressAutocomplete(inputId, suggestionsId, latFieldId, lngFieldId, markerType) {
      const input = document.getElementById(inputId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      const latField = document.getElementById(latFieldId);
      const lngField = document.getElementById(lngFieldId);

      let debounceTimer;

      input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const query = input.value.trim();

        if (query.length < 3) {
          suggestionsDiv.innerHTML = '';
          suggestionsDiv.style.display = 'none';
          return;
        }

        debounceTimer = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&country=GB&types=address,postcode&limit=5`
            );
            const data = await response.json();

            if (data.features && data.features.length > 0) {
              suggestionsDiv.innerHTML = data.features.map(feature =>
                `<div class="suggestion-item" data-lat="${feature.center[1]}" data-lng="${feature.center[0]}" data-label="${feature.place_name}">
                  <div style="font-weight:600;">${feature.text}</div>
                  <div style="font-size:12px; color:var(--muted);">${feature.place_name}</div>
                </div>`
              ).join('');
              suggestionsDiv.style.display = 'block';

              // Add click handlers
              suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                  input.value = item.dataset.label;
                  latField.value = item.dataset.lat;
                  lngField.value = item.dataset.lng;
                  suggestionsDiv.innerHTML = '';
                  suggestionsDiv.style.display = 'none';

                  // Update the map pin
                  updateMapMarker(markerType, parseFloat(item.dataset.lng), parseFloat(item.dataset.lat));
                });
              });
            } else {
              suggestionsDiv.innerHTML = '';
              suggestionsDiv.style.display = 'none';
            }
          } catch (err) {
            console.error('Geocoding error:', err);
          }
        }, 300);
      });

      // Close suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          suggestionsDiv.style.display = 'none';
        }
      });
    }

    setupAddressAutocomplete('pickup-input', 'pickup-suggestions', 'pickup-lat', 'pickup-lng', 'pickup');
    setupAddressAutocomplete('dropoff-input', 'dropoff-suggestions', 'dropoff-lat', 'dropoff-lng', 'dropoff');
  </script>

  <style>
    .form-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border: 1.5px solid var(--hair);
      border-radius: 12px;
      background: var(--bg);
      color: var(--text);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .suggestions-dropdown {
      position: relative;
      margin-top: 8px;
      background: var(--bg);
      border: 1.5px solid var(--hair);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid var(--hair);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background: var(--accent-light);
    }

    /* Address dot indicators */
    .addr-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }
    .addr-dot-pickup { background: #2ee59d; }
    .addr-dot-dropoff { background: #60a5fa; }

    /* Mini map styles */
    .mini-map-wrap {
      margin-top: 16px;
      border-radius: 14px;
      overflow: hidden;
      height: 0;
      opacity: 0;
      transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
    }
    .mini-map-wrap.map-visible {
      height: 200px;
      opacity: 1;
    }
    .mini-map {
      width: 100%;
      height: 200px;
      border-radius: 14px;
      border: 1px solid var(--hair);
    }

    /* Map pin markers */
    .map-pin {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 14px;
      color: #000;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
      border: 2px solid #fff;
    }
    .map-pin-pickup { background: #2ee59d; }
    .map-pin-dropoff { background: #60a5fa; }

    .property-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .property-card {
      cursor: pointer;
      position: relative;
    }

    .property-card input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .property-card-content {
      padding: 16px;
      border: 2px solid var(--hair);
      border-radius: 12px;
      text-align: center;
      transition: all 0.2s;
      background: var(--bg);
    }

    .property-card input:checked + .property-card-content {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .property-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .property-name {
      font-size: 13px;
      font-weight: 600;
    }

    @media (max-width: 480px) {
      .property-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .property-icon {
        font-size: 28px;
      }

      .property-name {
        font-size: 12px;
      }
    }
  </style>
{% endblock %}

{% block footer %}
  <div class="footer footer-clean">
    <div class="footer-inner">
      <button class="btn ready" type="submit" form="startForm">Continue</button>
    </div>
  </div>
{% endblock %}
